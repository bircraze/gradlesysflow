project.ext {
    sysEnvPrefix = "env"
    sysEnvDiv = "_"
    usingParallel = gradle.startParameter.isParallelProjectExecutionEnabled()
    commomAction = {
        if (!project.ext.envMap["steps"][name]["rootonly"]) {
            preExecChild(name, projectDir)
            return
        }
        if (project.ext.envMap["steps"][name]["cmd"]) {
            def cmd = project.ext.envMap["steps"][name]["cmd"]
            def args = []
            args << project.ext.envMap["steps"][name]["subcmd"] << project.ext.envMap["steps"][name]["args"]
            execCmd(cmd, args.flatten() - "" - null, projectDir)
        }
    }

    genEnvTasks()
}

subprojects {
    task execRootCmd {
        doLast {
            if (!project.ext.subs.contains(project.name)) {
                println "Ignored: " + project.name
                return
            }

            def argsArr = project.ext.args.split(",")
            def newArgsArr = []
            newArgsArr << project.ext.subcmd
            newArgsArr << argsArr.collect([]) {
                (it.split(":::")[0] && it.split(":::")[1] == project.name) ? it.split(":::")[0] : ""
            }
            execCmd(project.ext.cmd, newArgsArr.flatten() - "" - null, projectDir)
        }
    }
}

def genArgs(taskName, subs) {
    def argsArr = project.ext.envMap["steps"][taskName]["args"]
    def newArgsArr = []
    argsArr.each { arg ->
        if (arg.contains(":::")) {
            def pName = arg.split(":::")[1]
            project.ext.envMap["steps"][taskName][pName].each { p ->
                def newArg = arg.replace(":::${pName}:::", p.key)
                p.value.each { sub ->
                    newArgsArr << "${newArg}:::${sub}"
                }
            }
        } else {
            subs.each { sub ->
                newArgsArr << "${arg}:::${sub}"
            }
        }
    }
    def result = newArgsArr ? newArgsArr.join(",") : ""

    return result
}

def genSubs(taskName) {
    def argsArr = project.ext.envMap["steps"][taskName]["args"]
    argsArr = argsArr.findAll {
        it.contains(":::")
    }
    if (!argsArr) {
        return project.ext.envMap["parties"].join(",")
    }

    def newParties = []
    argsArr.each {
        def pName = it.split(":::")[1]
        newParties << project.ext.envMap["steps"][taskName][pName].values()
    }
    def result = newParties ? newParties.flatten().unique().join(",") : ""

    return result
}

def execCmd(cmd, argus, wdir) {
    println "===================================="
    println "Run cmd: ${cmd}, args: ${argus}, destDir: ${wdir}"
    project.exec {
        commandLine cmd
        //commandLine "git", "fetch"
        args argus
        //args "origin"
        workingDir wdir
    }
    println "===================================="
}

def preExecChild(taskName, wdir) {
    def argsArr = []
    def envCmd = project.ext.envMap["steps"][taskName]["cmd"]
    def envSubCmd = project.ext.envMap["steps"][taskName]["subcmd"]
    def subs = genSubs(taskName)
    argsArr << "execRootCmd"
    argsArr << "-Psubs=${subs}"
    argsArr << "-Pcmd=${envCmd}"
    argsArr << "-Psubcmd=${envSubCmd}"
    argsArr << "-Pargs=${genArgs(taskName, subs.split(','))}"

    def stepMap = project.ext.envMap["steps"][taskName]
    if (usingParallel && stepMap["parallel"] != null && stepMap["parallel"]) {
        execCmd("gradle", argsArr << "--parallel", wdir)
    } else {
        execCmd("gradle", argsArr, wdir)
    }
}

def genEnvTasks() {
    for (each in project.ext.properties.keySet()) {
        if (each.startsWith(project.ext.sysEnvPrefix)) {
            genMainTask(each.split(project.ext.sysEnvDiv)[1], project.ext.properties.get(each))
        }
    }
}

def genMainTask(taskName, taskMap) {
    task "${taskName}" {
        doLast {
            project.ext.envMap = taskMap
            taskMap["steps"].keySet().each {
                task "${it}"
                tasks."${it}".doLast(project.ext.commomAction)
                if (project.ext.prop("${it}ExAction")) {
                    tasks."${it}".doLast(project.ext."${it}ExAction")
                }
                tasks."${it}".execute()
            }
        }
    }
    tasks."${taskName}".group "Environment"
    tasks."${taskName}".description "Execute: ${taskMap['steps'].keySet()}"
}
